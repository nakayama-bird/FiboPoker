# セキュリティ設計の判断記録

## Phase 8: 厳格なRLSポリシー検討（不採用）

### 検討日
2026年1月3日

### 検討内容
より厳格なRow Level Security (RLS) ポリシーの導入を検討しました。

### 不採用とした理由

#### 1. ルームコードの性質
- 8文字ランダム英数字 = 推測攻撃は実質不可能（36^8 = 約2.8兆通り）
- コードを知っている = 参加権限がある、という設計思想

#### 2. Planning Pokerの性質
- 参加者リストは公開情報（ゲーム画面で表示される）
- カード選択結果も最終的に全員に公開される
- 協調的なツールであり、情報の秘匿性は重要ではない

#### 3. 既存の対策で十分
- **なりすまし**: Supabase Anonymous Authで防止済み
- **データ改ざん**: session_idチェックで防止済み
- **不正なラウンド操作**: is_ownerチェックで防止済み

#### 4. 実装上の課題
- 厳格なRLSポリシーは無限再帰エラーを引き起こす
- 回避策（permissive policy）は本来の目的を無効化する
- ルーム作成時のタイミング問題（参加者レコードより先に実行される）

### 結論
現状のセキュリティモデル（ルームコード + Anonymous Auth + RLS基本制御）で十分。
厳格なアクセス制御は、Planning Pokerの協調的な性質と相性が悪い。

### 参考
- 試行錯誤の記録: `supabase/migrations/002_security_improvements.sql`（実装試行）
- ロールバック: `supabase/migrations/003_rollback_security.sql`（元に戻す）
- PR: #14

### 将来的な拡張案
より厳格なアクセス制御が必要になった場合の選択肢：
- パスワード保護機能の追加
- レート制限の実装
- 招待制ルーム（ホワイトリスト方式）
