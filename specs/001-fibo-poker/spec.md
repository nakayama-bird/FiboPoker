# Feature Specification: フィボナッチポーカーアプリケーション

**Feature Branch**: `001-fibo-poker`  
**Created**: 2025-12-31  
**Status**: Draft  
**Input**: User description: "フィボナッチポーカーアプリケーションを開発します。複数のユーザーがリアルタイムでストーリーポイントを見積もれるツールです。ユーザーはルームを作成し、他のメンバーを招待できます。各メンバーはフィボナッチ数列（1, 2, 3, 5, 8, 13, 21など）からカードを選択し、全員が選択完了後に一斉に結果を公開します。結果画面では最大値、最低値、中央値、平均値が表示されます。"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - ルーム作成とカード選択 (Priority: P1)

ユーザーはルームを作成し、フィボナッチ数列のカードから1つを選択して見積もりを行えます。

**Why this priority**: この機能はアプリケーションの最小限のコア機能です。単独で使用可能な最小限のプランニングポーカー体験を提供します。

**Independent Test**: 1人のユーザーが新しいルームを作成し、カード（1, 2, 3, 5, 8, 13, 21）から1つを選択し、自分の選択を確認できることで独立してテスト可能です。

**Acceptance Scenarios**:

1. **Given** ユーザーがアプリケーションにアクセスした時、**When** ルーム作成ボタンをクリックすると、**Then** 新しいルームが作成され、一意のルームIDが生成される
2. **Given** ユーザーがルーム内にいる時、**When** フィボナッチ数列（1, 2, 3, 5, 8, 13, 21）のカードを表示すると、**Then** すべてのカードが選択可能な状態で表示される
3. **Given** ユーザーがカードの選択画面にいる時、**When** 任意のカード（例：5）をクリックすると、**Then** そのカードが選択状態になり、視覚的にハイライトされる
4. **Given** ユーザーがカードを選択した時、**When** 別のカードを選択すると、**Then** 前の選択が解除され、新しいカードが選択される

---

### User Story 2 - 見積もり完了の自動検知と結果表示 (Priority: P2)

全員がカードを選択完了した時点で自動的に検知され、統計情報（最大値、最低値、中央値、平均値）とともに結果が一斉に表示されます。

**Why this priority**: 自動完了検知とリアルタイム結果表示は、マニュアル操作より優れたユーザー体験を提供します。P1でマニュアル表示が可能になった後、自動化することで効率性が向上します。

**Independent Test**: 複数ユーザーが同じルームに参加し、全員がカードを選択すると、自動的に結果が表示され、最大値、最低値、中央値、平均値が正しく算出されることで独立してテスト可能です。

**Acceptance Scenarios**:

1. **Given** 複数のユーザーが同じルームにいる時、**When** 全員がカードを選択完了すると、**Then** システムが自動的に完了を検知する
2. **Given** 全員の見積もりが完了した時、**When** 完了検知から1秒以内に、**Then** 全参加者に対して選択されたカードが一斉に表示される
3. **Given** 結果が表示される時、**When** 統計情報を算出すると、**Then** 最大値、最低値、中央値、平均値が正確に計算され表示される
4. **Given** 結果表示画面が表示された時、**When** ユーザーが各参加者の選択を確認すると、**Then** 誰がどのカードを選択したかが明確に表示される
5. **Given** 結果表示後、**When** 新しいラウンドを開始すると、**Then** すべての選択がリセットされ、再度カード選択が可能になる

---

### User Story 3 - メンバー招待とルーム共有 (Priority: P3)

ルーム作成者は他のメンバーを招待でき、招待されたメンバーはルームに参加して見積もりに参加できます。

**Why this priority**: P1とP2で基本的な見積もり機能が完成します。メンバー招待機能は複数人での使用を容易にする補助機能であり、手動でルームURL共有する代替手段があります。

**Independent Test**: ルーム作成者が招待リンクを生成し、そのリンクを使って他のユーザーがルームに参加できることで独立してテスト可能です。

**Acceptance Scenarios**:

1. **Given** ユーザーがルームを作成した時、**When** 招待リンクを生成すると、**Then** 共有可能な一意のURLが生成される
2. **Given** 招待リンクが生成された時、**When** 他のユーザーがそのリンクにアクセスすると、**Then** 既存のルームに参加者として参加できる
3. **Given** ユーザーがルームに参加した時、**When** 参加者リストを表示すると、**Then** 現在のルーム内の全参加者の名前またはIDが表示される
4. **Given** 複数のユーザーがルームにいる時、**When** 1人がカードを選択すると、**Then** 他の参加者には「選択済み」の状態が表示される（選択内容は非表示）

---

### Edge Cases

- **ルームに参加者が1人だけの場合**: 1人でも見積もりを完了でき、統計情報（最大=最小=中央値=平均値）が表示される
- **全員が同じカードを選択した場合**: 最大値=最低値=中央値=平均値となり、合意が得られたことが明確に表示される
- **参加者数が偶数の場合の中央値**: 中央の2つの値の平均を中央値として算出する
- **カード選択中に接続が切れた場合**: 再接続時に現在のルーム状態が復元され、既に選択したカードがある場合は選択状態を維持する
- **結果表示前にユーザーが退出した場合**: 残りの参加者のみで統計情報を算出し、退出者の選択は除外する
- **ルーム作成者が退出した場合**: ルームは継続し、参加者は引き続き見積もりを行える（ルーム削除オプションは後の仕様で検討）
- **自動削除タイマーの動作**: 全参加者が退出して30分経過後、ルームとすべての関連データが自動削除される。最後の参加者に退出時に削除タイミングが通知される
- **削除警告の表示**: 自動削除の5分前に最後にアクティブだったユーザーに警告が表示される（接続中の場合）

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムはユーザーがルームを作成できる機能を提供しなければならない
- **FR-002**: システムは各ルームに一意の識別子（ルームID）を自動生成しなければならない
- **FR-003**: システムはフィボナッチ数列（1, 2, 3, 5, 8, 13, 21）のカード選択肢を提供しなければならない
- **FR-004**: ユーザーは表示されたカードから1つを選択できなければならない
- **FR-005**: ユーザーは選択したカードを変更できなければならない
- **FR-006**: システムは全参加者がカードを選択完了したことを自動的に検知しなければならない
- **FR-007**: システムは全員の選択完了後、1秒以内に全参加者に結果を配信しなければならない
- **FR-008**: システムは選択されたカードから最大値、最低値、中央値、平均値を算出しなければならない
- **FR-009**: 結果表示では各参加者が選択したカードと統計情報（最大値、最低値、中央値、平均値）が表示されなければならない
- **FR-010**: システムは招待用の共有可能なリンクを生成できなければならない
- **FR-011**: ユーザーは招待リンクを使用してルームに参加できなければならない
- **FR-012**: システムは現在のルーム参加者リストを表示しなければならない
- **FR-013**: システムは各参加者のカード選択状態（選択済み/未選択）を他の参加者に表示しなければならない（選択内容は結果表示まで非表示）
- **FR-014**: 結果表示後、システムは新しいラウンドを開始する機能を提供しなければならない
- **FR-015**: システムは接続断からの自動再接続機能を提供しなければならない
- **FR-016**: 再接続時、システムはユーザーの現在のルーム状態と選択状態を復元しなければならない
- **FR-017**: システムは一定時間操作がないルームとユーザー情報を自動的に削除しなければならない
- **FR-018**: システムは自動削除前にユーザーに警告を表示しなければならない

### Key Entities

- **Room（ルーム）**: 見積もりセッションを表す。一意のID、参加者リスト、現在のラウンド状態（選択中/結果表示中）を持つ
- **Participant（参加者）**: ルーム内のユーザーを表す。名前またはID、選択したカード値、選択完了状態を持つ
- **Card Selection（カード選択）**: 参加者の見積もりを表す。選択されたカード値（1, 2, 3, 5, 8, 13, 21のいずれか）、選択タイムスタンプを持つ
- **Round（ラウンド）**: 1回の見積もりサイクルを表す。ラウンド番号、全参加者の選択リスト、統計情報（最大値、最低値、中央値、平均値）、ラウンド状態（進行中/完了）を持つ

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: ユーザーはルーム作成から最初のカード選択まで30秒以内に完了できる
- **SC-002**: システムは全員の見積もり完了後、1秒以内に結果を全参加者に配信する
- **SC-003**: ユーザーアクション（カード選択、ルーム作成など）に対して300ms以内にUIフィードバックが表示される
- **SC-004**: システムは1ルームあたり最大20人の同時参加者をサポートする
- **SC-005**: 統計情報（最大値、最低値、中央値、平均値）は数学的に正確に算出される
- **SC-006**: 接続断から60秒以内にシステムは自動再接続を試み、ユーザー状態を復元する
- **SC-007**: 90%以上のユーザーが初回使用時に説明なしでルーム作成とカード選択を完了できる
- **SC-008**: 全参加者が退出してから30分後にルームとユーザー情報が自動削除される
- **SC-009**: 自動削除の5分前にアクティブユーザーに警告が表示される
